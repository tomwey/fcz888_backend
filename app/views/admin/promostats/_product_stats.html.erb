<% 
total_pv = LoanProductTrack.count
total_uv = LoanProductTrack.count('DISTINCT concat(ip,user_agent)')

today_pv = LoanProductTrack.where(created_at: Time.zone.now.beginning_of_day..Time.zone.now.end_of_day).count
today_uv = LoanProductTrack.where(created_at: Time.zone.now.beginning_of_day..Time.zone.now.end_of_day).count('DISTINCT concat(ip,user_agent)')

yes_pv = LoanProductTrack.where(created_at: (Time.zone.now - 1.days).beginning_of_day..(Time.zone.now - 1.days).end_of_day).count
yes_uv = LoanProductTrack.where(created_at: (Time.zone.now - 1.days).beginning_of_day..(Time.zone.now - 1.days).end_of_day).count('DISTINCT concat(ip,user_agent)')

pv_hash = LoanProductTrack.order('DATE(created_at)').group("DATE(created_at)").where('DATE(created_at) <= ?', Time.zone.now.to_date).count()

uv_hash = LoanProductTrack.order('DATE(created_at)').group("DATE(created_at)").where('DATE(created_at) <= ?', Time.zone.now.to_date).count('DISTINCT concat(ip,user_agent)')

dates = []
pv_data = []
uv_data = []

days = 30
days.times do |n|
  date = (Time.zone.now - (days - n - 1).days).to_date
  pv_data << (pv_hash[date] || 0).to_s
  uv_data << (uv_hash[date] || 0).to_s
  dates << date.to_s
end

 %>
<div class="event-stats">
  <div class="row">
    <div class="col">
      <div class="value"><%= total_pv %></div>
      <div class="name">总PV</div>
    </div>
    <div class="col">
      <div class="value"><%= yes_pv %></div>
      <div class="name">昨日PV</div>
    </div>
    <div class="col">
      <div class="value"><%= today_pv %></div>
      <div class="name">今日PV</div>
    </div>
    <div class="col">
      <div class="value"><%= total_uv %></div>
      <div class="name">总UV</div>
    </div>
    <div class="col">
      <div class="value"><%= yes_uv %></div>
      <div class="name">昨日UV</div>
    </div>
    <div class="col">
      <div class="value"><%= today_uv %></div>
      <div class="name">今日UV</div>
    </div>
  </div>
  <div class="stat-graph">
    <h4>近30天产品推广汇总</h4>
    <div id="graph2" style="width: 100%; height: 300px;"></div>
  </div>
</div>
<script src="https://cdn.bootcss.com/echarts/4.2.1/echarts.min.js"></script>
<script>
  var option = {
    tooltip: {
      show: true
    },
    legend: {
      data:['PV','UV']
    },
    xAxis: {
      type: 'category',
      data: JSON.parse('<%= raw dates.to_json %>')
    },
    yAxis: {
      type: 'value'
    },
    series: [
      {
        name: 'PV',
        data: JSON.parse('<%= raw pv_data.to_json %>'),
        type: 'line',
        smooth: true
      },
      {
        name: 'UV',
        data: JSON.parse('<%= raw uv_data.to_json %>'),
        type: 'line',
        smooth: true
      }
    ]
  };
  var myChart = echarts.init(document.getElementById('graph2'));
  myChart.setOption(option);
</script>